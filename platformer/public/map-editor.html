<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Map Editor</title>
  <style>
    body { margin:0; display:flex; flex-direction:column; height:100vh; }
    #editorArea { flex:1; display:flex; flex-direction:column; background:#1a1a1a; }
    #canvas { flex:1; background:#222; }
    #jsonPanel { width:360px; background:#121212; border-left:1px solid #333; display:flex; flex-direction:column; }
    #jsonPanel h3 { margin:0; padding:12px; font-size:14px; background:#1f1f1f; border-bottom:1px solid #333; }
    #editorOutput { flex:1; width:100%; border:none; resize:none; padding:12px; font-family:monospace; font-size:13px; background:#0f0f0f; color:#eee; overflow:auto; white-space:pre; }
    #copyBtn { background:#3b82f6; border:none; color:#fff; padding:8px; cursor:pointer; font-size:13px; }
    #copyBtn:hover { background:#2563eb; }
    #infoPanel { width:260px; background:#1a1a1a; padding:12px; border-left:1px solid #333; overflow-y:auto; }
    #infoPanel h3 { margin:0 0 8px; font-size:14px; }
    #infoPanel ul { list-style:none; padding:0; margin:0; }
    #infoPanel li { font-size:13px; margin:6px 0; }
    #toolbar {position:fixed;top:0;left:0;right:0;height:40px;display:flex;flex-direction:row;align-items:center;gap:8px;padding:6px;background:#333;color:#fff;z-index:1000;}
    #toolbar button,#toolbar select,#toolbar input {padding:4px 8px;font-size:14px;}
    #canvas {position:absolute;top:40px;left:0;}
    #jsonPanel {position:absolute;top:40px;right:0;width:300px;height:calc(100% - 40px);background:#111;color:#fff;display:flex;flex-direction:column;}
    #editorOutput,#jsonInput {flex:1;margin:4px;font-size:12px;background:#222;color:#0ff;}
  </style>
</head>
<body>
  <!-- Toolbar at the top -->
  <div id="toolbar">
    <button id="addBtn">Add</button>
    <button id="deleteBtn">Delete</button>
    <button id="saveBtn">Save</button>
    <button id="copyBtn">Copy</button>
    <input type="file" id="loadFile" />
    <select id="materialSelect">
      <option value="normal">Normal</option>
      <option value="ice">Ice</option>
      <option value="lava">Lava</option>
      <option value="bounce">Bounce</option>
      <option value="sticky">Sticky</option>
    </select>
    <button id="helpBtn">Help</button>
  </div>

  <!-- Canvas area -->
  <canvas id="canvas"></canvas>

  <!-- JSON panel -->
  <div id="jsonPanel">
    <textarea id="editorOutput"></textarea>
    <textarea id="jsonInput" placeholder="Paste JSON here"></textarea>
    <button id="loadTextBtn">Load from Text</button>
  </div>
<script>
  document.getElementById('helpBtn').addEventListener('click', () => {
    alert("Controls:\n- Arrow keys/WASD: Move camera\n- Click+Drag: Move block\n- Drag box: Select multiple\n- Corner handles: Scale block\n- Rotation handle above block: Rotate\n- Toolbar buttons: Add/Delete/Save/Copy/Load");
  });

  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  function resizeCanvas() {
    const right = document.getElementById('right');
    const hud = document.getElementById('hud');
    canvas.width = window.innerWidth - (right ? right.offsetWidth : 0);
    canvas.height = window.innerHeight - (hud ? hud.offsetHeight : 0);
  }
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();


  const addBtn = document.getElementById('addBtn');
  const deleteBtn = document.getElementById('deleteBtn');
  const saveBtn = document.getElementById('saveBtn');
  const copyBtn = document.getElementById('copyBtn');
  const loadFile = document.getElementById('loadFile');
  const loadTextBtn = document.getElementById('loadTextBtn');
  const materialSelect = document.getElementById('materialSelect');
  const jsonInput = document.getElementById('jsonInput');
  const output = document.getElementById('editorOutput');

  const worldWidth = 4000, worldHeight = 2000;
  let cameraX = 0, cameraY = 0;
  let world = { platforms: [] };
  let selectedIndices = [];

  // Dragging / transform state
  let dragOffsets = {};
  let draggingPlatform = false;
  let rotatingPlatform = false;
  let scalingPlatform = false;
  let activeHandle = null;
  let startMouse = null;
  let startPlatform = null;
  let startRotation = 0;

  // Group scaling state
  let scalingGroup = false;
  let startBounds, originalPlatforms;

  // Selection box state
  let selectingBox = false;
  let selectStartX = 0, selectStartY = 0;
  let selectCurrentX = 0, selectCurrentY = 0;

  function resizeCanvas() {
    const jsonPanel = document.getElementById('jsonPanel');
    const panelWidth = jsonPanel ? jsonPanel.offsetWidth : 0;
    canvas.width = window.innerWidth - panelWidth;
    canvas.height = window.innerHeight;
  }
  window.addEventListener('resize', resizeCanvas);

  function getHandles(p) {
    return [
      { x: p.x, y: p.y },
      { x: p.x + p.w, y: p.y },
      { x: p.x, y: p.y + p.h },
      { x: p.x + p.w, y: p.y + p.h }
    ];
  }

  function getGroupBounds() {
    const selected = selectedIndices.map(i => world.platforms[i]);
    const minX = Math.min(...selected.map(p => p.x));
    const minY = Math.min(...selected.map(p => p.y));
    const maxX = Math.max(...selected.map(p => p.x + p.w));
    const maxY = Math.max(...selected.map(p => p.y + p.h));
    return { x: minX, y: minY, w: maxX - minX, h: maxY - minY };
  }

  function redraw() {
    ctx.fillStyle = '#222';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    world.platforms.forEach((p, i) => {
      ctx.save();
      ctx.translate(p.x - cameraX + p.w/2, p.y - cameraY + p.h/2);
      ctx.rotate((p.rotation||0) * Math.PI/180);
      ctx.fillStyle =
        p.material==='ice' ? '#3b82f6' :
        p.material==='lava' ? '#ef4444' :
        p.material==='bounce' ? '#facc15' :
        p.material==='sticky' ? '#10b981' : '#888';
      ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      ctx.restore();

      if (selectedIndices.includes(i)) {
        ctx.strokeStyle = '#fff';
        ctx.strokeRect(p.x - cameraX, p.y - cameraY, p.w, p.h);

        ctx.fillStyle = '#fff';
        getHandles(p).forEach(h => ctx.fillRect(h.x - cameraX - 4, h.y - cameraY - 4, 8, 8));

        const cx = p.x + p.w/2;
        const hy = p.y - 40;
        ctx.fillStyle = '#0ff';
        ctx.beginPath();
        ctx.arc(cx - cameraX, hy - cameraY, 6, 0, Math.PI*2);
        ctx.fill();
        p.rotationHandle = { x: cx, y: hy };
      }
    });

    output.value = world.platforms.map(p => JSON.stringify(p)).join(',\n');
  }

  // Toolbar buttons
  addBtn.addEventListener('click', () => {
    world.platforms.push({ x: cameraX+100, y: cameraY+100, w:200, h:20, rotation:0, material:materialSelect.value });
    selectedIndices = [world.platforms.length-1];
    redraw();
  });
  deleteBtn.addEventListener('click', () => {
    world.platforms = world.platforms.filter((_,i)=>!selectedIndices.includes(i));
    selectedIndices = [];
    redraw();
  });
  saveBtn.addEventListener('click', () => { output.value = JSON.stringify(world.platforms,null,2); });
  copyBtn.addEventListener('click', () => { output.select(); document.execCommand('copy'); alert('JSON copied!'); });

  // Mouse events
  canvas.addEventListener('mousedown', e => {
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left + cameraX;
    const my = e.clientY - rect.top + cameraY;

    // Rotation handle
    if (selectedIndices.length===1) {
      const p = world.platforms[selectedIndices[0]];
      const rh = p.rotationHandle;
      if (rh && Math.hypot(mx-rh.x,my-rh.y)<10) {
        rotatingPlatform=true;
        startMouse={mx,my};
        startRotation=p.rotation;
        return;
      }
      // Corner handles for scaling
      const handles=getHandles(p);
      const foundHandle=handles.findIndex(h=>Math.hypot(mx-h.x,my-h.y)<8);
      if(foundHandle!==-1){
        scalingPlatform=true;
        activeHandle=foundHandle;
        startMouse={mx,my};
        startPlatform={...p};
        return;
      }
    }

    // Normal selection
    const found=world.platforms.findIndex(p=>mx>=p.x&&mx<=p.x+p.w&&my>=p.y&&my<=p.y+p.h);
    if(found===-1){
      selectingBox=true;
      selectStartX=mx; selectStartY=my;
      selectCurrentX=mx; selectCurrentY=my;
      selectedIndices=[];
    } else {
      if(!selectedIndices.includes(found)) selectedIndices=[found];
      dragOffsets={};
      selectedIndices.forEach(i=>{
        const p=world.platforms[i];
        dragOffsets[i]={dx:mx-p.x,dy:my-p.y};
      });
      draggingPlatform=true;
    }
  });

  canvas.addEventListener('mousemove', e => {
    const rect=canvas.getBoundingClientRect();
    const mx=e.clientX-rect.left+cameraX;
    const my=e.clientY-rect.top+cameraY;

    if(rotatingPlatform && selectedIndices.length===1){
      const p=world.platforms[selectedIndices[0]];
      const cx=p.x+p.w/2, cy=p.y+p.h/2;
      const angle=Math.atan2(my-cy,mx-cx)*180/Math.PI;
      p.rotation=angle;
      return;
    }

    if(scalingPlatform && selectedIndices.length===1){
      const p=world.platforms[selectedIndices[0]];
      const dx=mx-startMouse.mx, dy=my-startMouse.my;
      switch(activeHandle){
        case 0: p.x=startPlatform.x+dx; p.y=startPlatform.y+dy; p.w=startPlatform.w-dx; p.h=startPlatform.h-dy; break;
        case 1: p.y=startPlatform.y+dy; p.w=startPlatform.w+dx; p.h=startPlatform.h-dy; break;
        case 2: p.x=startPlatform.x+dx; p.w=startPlatform.w-dx; p.h=startPlatform.h+dy; break;
        case 3: p.w=startPlatform.w+dx; p.h=startPlatform.h+dy; break;
      }
      return;
    }

    if(draggingPlatform){
      selectedIndices.forEach(i=>{
        const p=world.platforms[i];
        p.x=mx-dragOffsets[i].dx;
        p.y=my-dragOffsets[i].dy;
      });
    }
  });

  canvas.addEventListener('mouseup', () => {
    rotatingPlatform=false;
    scalingPlatform=false;
    draggingPlatform=false;
    selectingBox=false;
    scalingGroup=false;
  });

  // Camera scroll
  document.addEventListener('keydown', e => {
    const step=50;
    if(e.key==='ArrowLeft'||e.key==='a') cameraX=Math.max(0,cameraX-step);
    if(e.key==='ArrowRight'||e.key==='d') cameraX=Math.min(worldWidth-canvas.width,cameraX+step);
    if(e.key==='ArrowUp'||e.key==='w') cameraY=Math.max(0,cameraY-step);
    if(e.key==='ArrowDown'||e.key==='s') cameraY=Math.min(worldHeight-canvas.height,cameraY+step);
  });

  // --- Auto-update loop ---
  function gameLoop() {
    redraw();
    requestAnimationFrame(gameLoop);
  }

  // --- Initialize ---
  window.addEventListener('load', () => {
    resizeCanvas();
    gameLoop();
  });
</script>
</body>
</html>

</body>
<html>
