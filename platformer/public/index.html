<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Platformer + Chat</title>
  <style>
    body { margin:0; font-family:"Segoe UI",sans-serif; background:#0f0f0f; color:#eee; }

    #hud { background:#1a1a1a; padding:8px; border-bottom:1px solid #333; }
    #editorBtn { background:#10b981; color:#fff; border:none; border-radius:6px; padding:6px 12px; cursor:pointer; }

    #canvas { display:block; margin:10px auto; background:#222; border:1px solid #333; }

    #players { background:#1a1a1a; padding:8px; border-bottom:1px solid #333; }
    #players ul { list-style:none; padding:0; margin:0; }

    #messages { list-style:none; margin:0; padding:10px; background:#121212; }
    #messages li { margin:6px 0; padding:8px 10px; border-radius:8px; background:#1f2937; }
    #messages li.self { background:#064e3b; }
    #messages .time { font-size:11px; opacity:0.6; margin-left:6px; }

    #chatForm { display:flex; gap:6px; padding:10px; background:#1a1a1a; }
    #chatInput { flex:1; padding:8px; border:1px solid #333; border-radius:6px; background:#111; color:#eee; }
    button { background:#3b82f6; color:#fff; border:none; border-radius:6px; padding:8px 12px; cursor:pointer; }
  </style>
</head>
<body>
  <div id="hud">
    <span id="username">You:</span>
    <button id="editorBtn">Map Editor</button>
    <span id="count">Players: 0</span>
  </div>

  <canvas id="canvas" width="800" height="600"></canvas>

  <div id="players">
    <h3>Online Players</h3>
    <ul id="playerList"></ul>
  </div>

  <ul id="messages"></ul>
  <form id="chatForm">
    <input id="chatInput" autocomplete="off" placeholder="Type a message..." />
    <button>Send</button>
  </form>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const messages = document.getElementById('messages');
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const playerList = document.getElementById('playerList');
    const usernameLabel = document.getElementById('username');
    const countLabel = document.getElementById('count');
    document.getElementById('editorBtn').onclick = () => { window.location.href = '/map-editor.html'; };

    let myUsername = null;
    let world = null;
    let players = {};
    const SIZE = { w:40, h:60 };

    socket.on('auth', ({ username }) => {
      myUsername = username;
      usernameLabel.textContent = "You: " + username;
    });
    socket.on('world', payload => { world = payload.world; players = payload.players||{}; updatePlayerList(); });
    socket.on('player join', ({ username, state }) => { players[username]=state; updatePlayerList(); });
    socket.on('player leave', ({ username }) => { delete players[username]; updatePlayerList(); });
    socket.on('state', serverPlayers => { players=serverPlayers; updatePlayerList(); });

    const input = { left:false,right:false,up:false };
    const keymap = { ArrowLeft:'left', ArrowRight:'right', ArrowUp:'up', a:'left', d:'right', w:'up', ' ':'up' };
    window.addEventListener('keydown', e => { const k=keymap[e.key]; if(k){ input[k]=true; socket.emit('input',input);} });
    window.addEventListener('keyup', e => { const k=keymap[e.key]; if(k){ input[k]=false; socket.emit('input',input);} });

    chatForm.addEventListener('submit', e => {
      e.preventDefault();
      const text = chatInput.value.trim();
      if(!text) return;
      socket.emit('chat message', text);
      chatInput.value='';
    });
    socket.on('chat history', history => { messages.innerHTML=''; history.forEach(addMessage); });
    socket.on('chat message', addMessage);

    function addMessage(msg){
      const li=document.createElement('li');
      const time=document.createElement('span');
      time.className='time';
      time.textContent=new Date(msg.time).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
      li.textContent=`${msg.user}: ${msg.text}`;
      li.appendChild(time);
      if(msg.user===myUsername) li.classList.add('self');
      messages.appendChild(li);
    }

    function updatePlayerList(){
      playerList.innerHTML='';
      Object.keys(players).forEach(u=>{
        const li=document.createElement('li');
        li.textContent=u;
        playerList.appendChild(li);
      });
      countLabel.textContent="Players: "+Object.keys(players).length;
    }

    function drawPlatform(p){
      ctx.save();
      ctx.translate(p.x+p.w/2, p.y+p.h/2);
      ctx.rotate((p.rotation||0)*Math.PI/180);
      ctx.fillStyle="#888";
      ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h);
      ctx.restore();
    }

    function render(){
      if(!world){ requestAnimationFrame(render); return; }
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle='#222';
      ctx.fillRect(0,0,world.width,world.height);
      for(const plat of world.platforms) drawPlatform(plat);
      for(const [u,p] of Object.entries(players)){
        ctx.fillStyle=p.color||'#a3e635';
        ctx.fillRect(p.x,p.y,SIZE.w,SIZE.h);
      }
      requestAnimationFrame(render);
    }
    requestAnimationFrame(render);
  </script>
</body>
</html>
